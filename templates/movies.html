{% extends "base.html" %}
{% load static %}

{% block title %}
    {% if movie %}
        {{ movie.title }} - WatchCraft
    {% else %}
        Movies
    {% endif %}
{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'css/movies.css' %}">
{% endblock %}

{% block content %}
<div class="container">

    {% if movie %}
        <!-- ===== Movie Detail View ===== -->
        <div class="movie-detail flex-row">

            <!-- Poster Image -->
            <div class="poster">
                {% if movie.poster_url %}
                    <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
                {% else %}
                    <div class="no-poster">No Poster</div>
                {% endif %}
            </div>

            <!-- Movie Info -->
            <div class="movie-info">
                <h1>{{ movie.title }}</h1>
                <p>{{ movie.genre }} | {{ movie.release_year }}</p>
                <p>{{ movie.description }}</p>

                <!-- Average Rating -->
                {% with avg=movie.get_average_rating %}
                    {% if avg %}
                        <p>Average Rating: {{ avg }}/5</p>
                    {% else %}
                        <p>No ratings yet.</p>
                    {% endif %}
                {% endwith %}

                <!-- Reviews -->
                <div class="reviews">
                    <h2>Reviews</h2>
                    {% if movie.review_set.all %}
                        <ul>
                            {% for review in movie.review_set.all %}
                                <li>
                                    <p><strong>{{ review.user.username }}:</strong></p>

                                    <!-- Star Rating -->
                                    <p>
                                        {% for i in "12345"|make_list %}
                                            {% if review.rating|add:"0" >= i|add:"0" %}
                                                <span class="star filled">â˜…</span>
                                            {% else %}
                                                <span class="star">â˜†</span>
                                            {% endif %}
                                        {% endfor %}
                                        <span class="numeric-rating">({{ review.rating }}/5)</span>
                                    </p>

                                    <!-- Review Comment -->
                                    {% if review.comment %}
                                        <p>{{ review.comment }}</p>
                                    {% else %}
                                        <p><em>No comment provided.</em></p>
                                    {% endif %}
                                </li>
                            {% endfor %}
                        </ul>
                    {% else %}
                        <p>No reviews yet.</p>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Back Button -->
        <div class="mt-8">
            <a href="{% url 'movie-list' %}" class="btn">
                &larr; Back to Movies
            </a>
        </div>

    {% else %}
        <!-- ===== Movies List View ===== -->
        <h2>ðŸŽ¥ Movies</h2>

        <!-- Search Bar -->
        <div class="search-bar">
            <form method="get" action="{% url 'movie-list' %}" class="flex w-full gap-2">
                <input type="text" name="q" placeholder="Search movies..."
                       class="input" value="{{ search_query }}">
                <button type="submit" class="btn">Search</button>
            </form>
        </div>

        <!-- Grid View -->
        <div class="movies-grid">
            {% for movie in object_list %}
                <div class="movie-card">
                    {% if movie.poster_url %}
                        <img src="{{ movie.poster_url }}" alt="{{ movie.title }}">
                    {% else %}
                        <div class="no-poster">No Poster</div>
                    {% endif %}

                    <h3>{{ movie.title }}</h3>
                    <p>{{ movie.genre }} | {{ movie.release_year }}</p>
                    <p>{{ movie.description|default:"No description available" }}</p>

                    <!-- View Details Button -->
                    <a href="{% url 'movie-detail' movie.id %}" class="btn">View Details</a>
                </div>
            {% empty %}
                <p>No movies found.</p>
            {% endfor %}
        </div>
    {% endif %}

</div>
{% endblock %}
